# UAV20241021 输电系统红外热成像智能检测系统说明书

**版本**: 1.0
**日期**: 2025-09-20
**作者**: AI Assistant

---

## 1. 系统概述

本系统是一个基于红外热成像技术的输电设备智能检测系统。其核心功能是利用无人机采集的设备红外温度数据，通过深度学习模型自动检测图像中的电力设备，并分析其温度状态，从而实现对潜在设备故障的早期预警。

系统的关键特性是 **“温度数据驱动”**：它不依赖于传统的可见光图像，而是直接将原始的、精确的温度矩阵数据转换为热力图，并以此作为模型训练和推理的输入。这种方法使得检测不仅能识别设备位置，还能直接利用与设备状态强相关的温度信息，极大地提高了故障诊断的准确性。

## 2. 系统架构

本系统采用模块化设计，由四个核心 Python 脚本和一个配置文件组成，各模块职责分明，共同构成一个完整的数据处理与分析流水线。

**架构草图:**
```
┌───────────────────┐
│   原始数据          │
│ (TXT, XML, JPG)   │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│ 1. data_preprocessing.py │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│   处理后的数据        │
│ (热力图, YOLO标签)  │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│ 2. model_training.py     │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│   训练好的模型        │
│ (best_thermal_model.pt) │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│ 3. multimodal_inference.py │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│   推理结果          │
│ (results.json)    │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│ 4. visualization.py      │
└─────────┬─────────┘
          │
          v
┌───────────────────┐
│   可视化报告        │
│ (PNG 图片)        │
└───────────────────┘
```

- **`UAV20241021_system/`**: 项目主目录。
    - **`data_preprocessing.py`**: 数据预处理器。负责将原始数据（温度TXT、标注XML）转换为模型训练所需的格式。
    - **`model_training.py`**: 模型训练器。负责配置和启动YOLOv11-OBB模型的训练过程。
    - **`multimodal_inference.py`**: 多模态推理引擎。使用训练好的模型对新的温度数据进行推理，并保存检测结果。
    - **`visualization.py`**: 结果可视化器。将推理结果生成直观的图表和对比图像。
    - **`config.json`**: 全局配置文件。集中管理所有路径、参数和设置，方便调整。
    - **`yolov11-OBB-main/`**: YOLOv11-OBB 模型的源代码和依赖。
    - **`data/`**: 存放原始数据集。

## 3. 实现流程详解

系统的数据处理流程遵循一个清晰的、分步骤的顺序，从原始数据输入到最终的可视化报告输出。您需要按顺序手动执行以下 Python 脚本。

### 步骤一：数据预处理 (执行 `data_preprocessing.py`)

这是所有工作的第一步，目的是准备训练所需的数据集。

-   **输入**:
    -   原始温度数据: `data/.../UAV.../` 目录下的 `.txt` 文件。
    -   原始标注数据: 同一目录下的 `.xml` 文件，包含旋转边界框坐标。
-   **执行**:
    ```bash
    python data_preprocessing.py
    ```
-   **过程**:
    1.  脚本会读取 `config.json` 中定义的原始数据路径。
    2.  它遍历每个样本，读取其 `.txt` 温度矩阵，并将其转换为标准的热力图（`.jpg` 格式）。
    3.  同时，它解析对应的 `.xml` 标注文件，提取出旋转矩形的坐标。
    4.  然后，它将这些坐标转换为 YOLO-OBB 模型可以理解的标签格式（一个包含归一化坐标和角度的 `.txt` 文件）。
    5.  最后，脚本会自动创建 `yolo_dataset/dataset.yaml` 文件，这个文件是启动训练所必需的，它告诉模型训练集和验证集在哪里。
-   **输出**:
    -   `processed_data/thermal_images/`: 生成的热力图。
    -   `processed_data/labels/`: 生成的YOLO格式标签。
    -   `yolo_dataset/dataset.yaml`: 数据集配置文件。

### 步骤二：模型训练 (执行 `model_training.py`)

在数据准备好之后，可以开始训练模型。

-   **输入**:
    -   上一步生成的 `yolo_dataset/dataset.yaml` 和所有处理好的数据。
    -   预训练模型 `yolo11s-obb.pt`。
-   **执行**:
    ```bash
    python model_training.py
    ```
-   **过程**:
    1.  脚本首先检查环境中是否有可用的 GPU，并优先使用 GPU 进行加速。
    2.  它会加载 `config.json` 中定义的训练参数，如 `epochs` (训练轮数) 和 `batch_size` (批处理大小)。
    3.  然后，它调用 `yolov11-OBB-main` 库，并根据 `dataset.yaml` 文件开始在您的热力图数据集上进行训练。
    4.  训练过程可能需要较长时间，具体取决于您的数据量和硬件性能。
-   **输出**:
    -   `best_thermal_model.pt`: 训练完成后得到的最佳模型权重文件，保存在项目根目录。
    -   `runs/thermal_detection/...`: 包含训练日志、图表和中间结果的文件夹。

### 步骤三：模型推理 (执行 `multimodal_inference.py`)

训练好模型后，可以用它来检测新的、未见过的数据。

-   **输入**:
    -   训练好的 `best_thermal_model.pt` 模型。
    -   需要进行检测的新的温度 `.txt` 文件（放置在 `config.json` 指定的推理输入目录中）。
-   **执行**:
    ```bash
    python multimodal_inference.py
    ```
-   **过程**:
    1.  脚本加载 `best_thermal_model.pt` 模型。
    2.  它会遍历所有待检测的温度文件，将它们逐一转换为热力图。
    3.  然后将这些热力图送入模型进行预测，获取图中每个目标的边界框、类别和置信度。
    4.  脚本会收集所有检测结果，并进行汇总。
-   **输出**:
    -   `inference_results/inference_detection_results.json`: 一个包含所有检测结果的 JSON 文件，为下一步可视化做准备。

### 步骤四：结果可视化 (执行 `visualization.py`)

最后一步是将枯燥的检测数据转换成直观的报告。

-   **输入**:
    -   上一步生成的 `inference_detection_results.json` 文件。
    -   `processed_data` 目录下的热力图和原始可见光图（用于对比）。
-   **执行**:
    ```bash
    python visualization.py
    ```
-   **过程**:
    1.  脚本读取 JSON 文件中的所有检测结果。
    2.  对于每一个被检测的样本，它会生成一张包含四个子图的详细报告（`.png` 格式），这四个子图分别是：原始可见光图、带检测框的热力图、纯热力图、温度统计分析图。
    3.  在处理完所有单个样本后，脚本还会生成一张包含整体统计信息的总结报告图。
-   **输出**:
    -   `visualization_results/detection_results/`: 存放每个样本的详细四宫格图。
    -   `visualization_results/temperature_analysis/`: 存放最终的总结报告图。

## 4. 核心模块详解

### 4.1. `data_preprocessing.py`

-   **`ThermalDataPreprocessor` 类**: 封装了所有预处理逻辑。
-   **核心功能**:
    -   `convert_thermal_to_image()`: 将温度矩阵归一化到 0-255 范围，并应用 `cv2.COLORMAP_HOT` 色彩映射，生成视觉上直观的热力图。
    -   `parse_xml_annotation()`: 使用 `xml.etree.ElementTree` 解析XML，提取旋转矩形的四个角点坐标。
    -   `save_yolo_label()`: 将角点坐标转换为YOLO-OBB格式（`cx, cy, w, h, angle`），并写入文本文件。
    -   `create_dataset_yaml()`: 动态生成YOLO训练所需的 `dataset.yaml` 配置文件。

### 4.2. `model_training.py`

-   **`ThermalYOLOTrainer` 类**: 管理训练环境和流程。
-   **核心功能**:
    -   `setup_environment()`: 确保所有必要的目录和文件（如 `dataset.yaml`）都已准备就绪。
    -   `check_gpu_availability()`: 检查系统中是否存在可用的NVIDIA GPU，并据此设置训练设备（`cuda:0` 或 `cpu`）。
    -   `train_model()`: 构造 `ultralytics` 库的 `YOLO` 对象，并调用其 `train()` 方法。这是实际执行训练的入口。
    -   训练结束后，脚本会自动将 `yolov11-OBB-main/runs/obb/train/weights/best.pt` 复制并重命名为项目根目录下的 `best_thermal_model.pt`，方便后续使用。

### 4.3. `multimodal_inference.py`

-   **`ThermalInferenceEngine` 类**: 负责执行目标检测。
-   **核心功能**:
    -   `load_model()`: 加载 `best_thermal_model.pt` 权重文件。
    -   `detect_objects()`: 调用模型的 `predict()` 方法对输入的图像进行推理。
    -   `batch_inference()`: 遍历指定的推理数据目录，对每个温度文件执行完整的“加载-转换-推理”流程。
    -   `save_detection_results_json()`: 将每个样本的详细检测结果（包括样本名、检测框、置信度、类别、温度统计等）结构化地写入一个JSON文件中。

### 4.4. `visualization.py`

-   **`ThermalVisualization` 类**: 结果的图形化展示工具。
-   **核心功能**:
    -   `load_inference_results()`: 从JSON文件中安全地加载推理数据。
    -   `draw_detection_boxes()`: 使用OpenCV在图像上绘制旋转的边界框、中心点和标签。
    -   `visualize_detection_result()`: **核心可视化函数**。使用 Matplotlib 创建一个 2x2 的子图，将原始图像、检测结果图、热力图和温度统计图整合到一张图中，实现多维度对比。
    -   `plot_temperature_analysis()`: 绘制条形图，展示检测区域的最高、最低和平均温度。
    -   `create_summary_report()`: 在所有样本处理完毕后，生成一个包含整体统计（如各样本检测数、温度分布直方图等）的最终报告。

## 5. 配置文件 (`config.json`)

该文件是系统的“控制中心”，允许用户在不修改代码的情况下调整系统行为。

```json
{
  "paths": {
    "project_root": "...",
    "raw_data_dir": "...",
    "processed_data_dir": "...",
    // ... 其他路径
  },
  "data_processing": {
    "image_size": [640, 640],
    "colormap": "hot",
    "train_val_split": 0.9
  },
  "model_training": {
    "base_model": "yolo11s-obb.pt",
    "epochs": 100,
    "batch_size": 8,
    "device": "auto" // "auto", "cpu", "0"
  },
  "inference": {
    "model_path": "best_thermal_model.pt",
    "confidence_threshold": 0.4
  }
}
```

-   **`paths`**: 定义了所有重要的文件和目录路径，使得项目可以在不同环境中轻松迁移。
-   **`data_processing`**: 控制数据预处理的行为，如生成图像的尺寸、使用的色谱等。
-   **`model_training`**: 定义训练相关的超参数，如训练轮数、批处理大小、使用的设备等。
-   **`inference`**: 指定推理时使用的模型和置信度阈值。

## 6. 如何运行系统

由于您不希望使用 `run.sh` 脚本，您可以通过在终端中按顺序手动执行每个核心的 Python 脚本来运行整个流程。

**前置要求**:
- 确保您已经安装了所有必要的 Python 库（如 `numpy`, `opencv-python`, `matplotlib`, `seaborn`, `torch`, `ultralytics`）。
- 确保您的 Conda 环境（例如 `jyc_conda`）已被激活。

**执行步骤**:

1.  **第一步：数据预处理**
    在终端中运行 `data_preprocessing.py` 脚本，为模型准备数据。
    ```bash
    python data_preprocessing.py
    ```

2.  **第二步：模型训练**
    数据准备好后，运行 `model_training.py` 来训练模型。
    ```bash
    python model_training.py
    ```

3.  **第三步：执行推理**
    模型训练完成后，使用 `multimodal_inference.py` 对新数据进行检测。
    ```bash
    python multimodal_inference.py
    ```

4.  **第四步：结果可视化**
    最后，运行 `visualization.py` 将检测结果生成可视化的图表。
    ```bash
    python visualization.py
    ```

通过依次执行这四个脚本，您就可以完成从数据处理到最终报告生成的完整流程。

---
**说明书完**